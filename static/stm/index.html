<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Unfiltered Presentation by Dustin Whitney</title>
	<meta http-equiv="expires" content="0"> <!-- DO NOT DELETE THIS! -->
	<link rel="stylesheet" href="assets/prettify/prettify.css"> <!-- You can remove this if your presentation is not about programming -->
	<link rel="stylesheet" media="screen, projection" href="assets/css/pik5.css"> <!-- DO NOT DELETE THIS! -->
	<link rel="stylesheet" media="screen, projection" href="themes/pik5/style.css"> <!-- Use this to style your presentation -->
	<link rel="stylesheet" media="print" href="themes/pik5/print.css"> <!-- Use this to make your presentation print well -->
	<script> var pik5_base_dir = ''; </script> <!-- Change this if this presentation file is NOT in the same folder as all other P5 files and folders -->
	<script src="assets/prettify/prettify.js"></script> <!-- You can remove this if your presentation is not about programming -->
	<script src="assets/js/jquery.js"></script> <!-- DO NOT DELETE THIS! -->
	<script src="assets/js/shared.js"></script> <!-- DO NOT DELETE THIS! -->
	<script src="assets/js/pik5.js"></script> <!-- DO NOT DELETE THIS! -->
	<script src="custom.js"></script> <!-- Use this for your own slide programming -->
	<base target="_blank">
	<style type="text/css">
	</style>
</head>
<body onload="prettyPrint()"> <!-- You can remove the onload property if your presentation is not about programming -->


<div id="header">
	<h1>Unfiltered Presentation for Scala eXchange</h1>
	<a href="http://twitter.com/dustinwhitney">@dustinwhitney</a>
</div>


<div id="frame"> <!-- DO NOT DELETE THIS! -->


<div id="framecontainer"> <!-- DO NOT DELETE THIS! -->


<div class="pik5-slide" id="start">
  <h2><a href="https://github.com/n8han/Unfiltered">STM</a></h2>
	<p style="font-size:x-large">Dustin Whitney, CTO Trust Metrics, <a href="http://twitter.com/dustinwhtney">@dustinwhitney</a></p>
	<p style="font-size:x-large">
		Just a place holder
	</p>
</div>


<div class="pik5-slide">
	<h2>Just Plain Bad</h2>
	<code class="prettyprint">
	  <pre class="prettyprint">
      class Account(val accountNo: String, var balance: Int){
        def credit(amount: Int) = balance = balance + amount
        def debit(amount: Int) = balance = balance - amount
      }
    </pre>
	</code>
</div>

<div class="pik5-slide">
	<h2>Fixed</h2>
	<code class="prettyprint">
	  <pre class="prettyprint">
      class Account(val accountNo: String, beginningBalance: Int){
        private var _balance = beginningBalance
        def balance = this.synchronized{ _balance }
        def credit(amount: Int) = this.synchronized{ _balance = _balance + amount }
        def debit(amount: Int) = this.synchronized { _balance = _balance - amount }
      }
    </pre>
	</code>
</div>

<div class="pik5-slide">
	<h2>Race Condition</h2>
	<code class="prettyprint">
	  <pre class="prettyprint" style="font-size:medium">
      object AccountManager{

        def transfer(from: Account, to: Account, amount: Int): Unit = {
          if(from.balance > amount){
            to.credit(amount)
            from.debit(amount)
          }else throw new RuntimeException("Balance too low!")
        }

      }

      class Account(val accountNo: String, beginningBalance: Int){
        private var _balance = beginningBalance
        def balance = this.synchronized{ _balance }
        def credit(amount: Int) = this.synchronized{ _balance = _balance + amount }
        def debit(amount: Int) = this.synchronized { _balance = _balance - amount }
      }
    </pre>
	</code>
</div>

<div class="pik5-slide">
	<h2>Dead Lock</h2>
	<code class="prettyprint">
	  <pre class="prettyprint" style="font-size:medium">
      object AccountManager{

        def transfer(from: Account, to: Account, amount: Int): Unit = {
          to.synchronized{
            from.synchronized{
              if(from.balance > amount){
                to.credit(amount)
                from.debit(amount)
              }
            }
          }
        }

      }

      class Account(val accountNo: String, beginningBalance: Int){
        private var _balance = beginningBalance
        def balance = this.synchronized{ _balance }
        def credit(amount: Int) = this.synchronized{ _balance = _balance + amount }
        def debit(amount: Int) = this.synchronized { _balance = _balance - amount }
      }
    </pre>
	</code>
</div>

<div class="pik5-slide">
	<h2>Fixed</h2>
	<code class="prettyprint">
	  <pre class="prettyprint" style="font-size:medium">
      object AccountManager{

        def transfer(from: Account, to: Account, amount: Int): Unit = {
          val (lockOne, lockTwo) = if(from.accountNo < to.accountNo) (from, to) else (to, from)
          lockOne.synchronized{
            lockTwo.synchronized{
              if(from.balance > amount){
                to.credit(amount)
                from.debit(amount)
              }
            }
          }
        }

      }

      class Account(val accountNo: String, beginningBalance: Int){
        private var _balance = beginningBalance
        def balance = this.synchronized{ _balance }
        def credit(amount: Int) = this.synchronized{ _balance = _balance + amount }
        def debit(amount: Int) = this.synchronized { _balance = _balance - amount }
      }
    </pre>
	</code>
</div>

<div class="pik5-slide">
	<h2>Fixed</h2>
	<code class="prettyprint">
	  <pre class="prettyprint" style="font-size:medium">
      object AccountManager{

        def transfer(from: Account, to: Account, amount: Int): Unit = {
          val balance = (from !? Balance).asInstanceOf[Int]
          if(balance > amount){
            to ! Credit(amount)
            from ! Debit(amount)
          }
        }

      }

      case class Credit(amount: Int)
      case class Debit(amount: Int)
      case object Balance

      class Account(val accountNo: String, beginningBalance: Int) extends Actor{
        private var _balance = beginningBalance

        def act = {
          loop{
            receive{
              case Credit(amount) => _balance = _balance + amount
              case Debit(amount) => _balance = _balance - amount
              case Balance => reply(_balance)
            }
          }
        }
      }
    </pre>
	</code>
</div>



</div> <!-- End #framecontainer. DO NOT DELETE THIS! -->


</div> <!-- End #frame. DO NOT DELETE THIS! -->


</body>
</html>

